---
author: "Sean Davis"
title:  "Wrap a basic tool for with R"
date:   "May 2, 2016"
output: html_report
---

## Introduction

In this little tutorial, I am going to use the `sevenbridges` R package to develop a small
tool that does a download of a URL to a file on the local disk.  I will be wrapping that tool
in a [common workflow language](http://www.commonwl.org/) wrapper and then uploading the resulting
tool into the [SevenBridges](https://cgc.sevenbridges.com/) system.  Finally, I will execute
that tool on the cloud via an API call.

## Background

The [SevenBridges Cancer Genomics Cloud](https://cgc.sbgenomics.com) is built around the concept of reproducible workflows based
on the [Common Workflow Language standard](http://www.commonwl.org/). SevenBridges has
an Application Programming Interface [API](https://en.wikipedia.org/wiki/Application_programming_interface)
that allows programmatic access and control of the platform. The combination of
an industrial workflow engine running on cloud infrastructure, available tools
and workflows, and a programming language like [R](https://www.r-project.org).

## Load library and initialize

```{r}
library(sevenbridges)
```

## Preparing the inputs and outputs

The [common workflow language](http://www.commonwl.org/draft-3/UserGuide.html) describes in some detail the 
details of the YAML file that describes a tool. The approach that is used in the `sevenbridges` package
is to allow the developer to describe the tool using `R` code. In the next code block, I am 
describing the inputs and outputs of our very simple tool, a command-line R script.

```{r}
in.lst = list(input(id='url',
                    description='URL of the download',
                    type='string',
                    position=1),
              input(id='ofname',
                    description='output filename',
                    type='string',
                    position=2))

out.lst = list(output(id='file',
                      glob=('output/*')))
```

```{r}
fl = "get_http_file.R"
library(readr)
fd = fileDef(name='get_http_file.R',
             content=read_file(fl))

rbx <- Tool(id = "get_http_file", 
            label = "get_http_file",
            hints = requirements(docker(pull = "rocker/hadleyverse"), 
                                 cpu(1), mem(2000)),
            requirements = requirements(fd),
            baseCommand = "Rscript get_http_file.R",
            inputs = in.lst,
            outputs = out.lst)
```

```{r}
a <- Auth(platform = "cgc", username = "sdavis2")
p = a$project('temp-batch')
app.txfr = p$app_add("txfr", rbx)
aid <- app.txfr$id
p$task_add(name='transfer test',
           description='transfer test desc',
           app=aid,
           inputs=list(
              url='http://hgdownload.cse.ucsc.edu/goldenPath/hg38/bigZips/hg38.trf.bed.gz',
              ofname='hg38.trf.bed.gz'))
(tsk = p$task(status='draft'))
tsk$run()

```
